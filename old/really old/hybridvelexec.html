
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>hybridvelexec</title>
      <meta name="generator" content="MATLAB 7.5">
      <meta name="date" content="2013-05-28">
      <meta name="m-file" content="hybridvelexec"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#2">Initialize</a></li>
               <li><a href="#3">Process the image with different filters</a></li>
               <li><a href="#4">Iterative Radon transform</a></li>
            </ul>
         </div><pre class="codeinput"><span class="comment">% [angle,utheta,uvar] = hybridvel(imread('fig9im.tif'),1,[],0.47,1,100,25,[1 125]);</span>
</pre><h2>Initialize<a name="2"></a></h2><pre class="codeinput"><span class="comment">% load the image</span>
imgtitle = <span class="string">'fig9im.tif'</span>;
inputimg = imread(imgtitle);

<span class="comment">% set up parameters</span>
imsize = size(inputimg);
inputimg = double(inputimg);
anglineth = 3;
dvov = 0.1/100; <span class="comment">% dv/v to determine minimum step-size</span>
firstthetastep = 45; thetarange = [0 179];
ds = 4; <span class="comment">% 4 um streak distance</span>
showimg = 1;
delx = 0.47; <span class="comment">% microns/pixel</span>
delt = 1; <span class="comment">% ms/line</span>
hi = 100;
lineskip = 25;
xrange = [1 125];

<span class="keyword">if</span> ~isempty(xrange) &amp;&amp; length(xrange)&lt;3
    <span class="keyword">if</span> length(xrange)==1
        wi = xrange; xrange = [1 wi];
    <span class="keyword">else</span>
        <span class="keyword">if</span> xrange(1)&gt;imsize(2)-1
            xrange(1)=1;
        <span class="keyword">end</span>
        <span class="keyword">if</span> xrange(2)&gt;imsize(2)-1
            xrange(2)=imsize(2)-2;
        <span class="keyword">end</span>
        <span class="keyword">if</span> xrange(2)&lt;xrange(1)
            xrange = [xrange(1) xrange(2)];
        <span class="keyword">end</span>
        wi = xrange(2)-xrange(1)+1;
    <span class="keyword">end</span>
<span class="keyword">else</span>
    wi = imsize(2)-2; xrange = [1 wi];
<span class="keyword">end</span>

warning <span class="string">off</span>
</pre><h2>Process the image with different filters<a name="3"></a></h2><pre class="codeinput">curimtitle = {<span class="string">'edm'</span>,<span class="string">'vdm'</span>,<span class="string">'sob'</span>}; curcolor = {<span class="string">'b'</span>,<span class="string">'g'</span>,<span class="string">'k'</span>,<span class="string">'r'</span>,<span class="string">'c'</span>,<span class="string">'m'</span>};
imgseg(:,:,1) = inputimg(2:end-1,2:end-1)-mean(mean(inputimg(2:end-1,2:end-1))); <span class="comment">% element-wise demean</span>
imgseg(:,:,2) = bsxfun(@minus,inputimg(2:end-1,2:end-1),<span class="keyword">...</span>
    mean(inputimg(2:end-1,2:end-1),1)); <span class="comment">% vertical demean</span>
imgseg(:,:,3) = filter2([1 2 1; 0 0 0; -1 -2 -1],inputimg,<span class="string">'valid'</span>);  <span class="comment">% 3x3 vertical Sobel filter, Eq. 5,6</span>

imgsegsz = size(imgseg);
firstiter = (thetarange(1):firstthetastep:thetarange(2));
firstiter = firstiter-(firstiter(end)-firstiter(1))/2+1;

segend = hi:lineskip:imgsegsz(1);
segstart = segend-hi+1;
segn = length(segstart);

angle = nan(segn,9,imgsegsz(3)); <span class="comment">% angle = [angle,minstep,loc(pix),dels1,deln,%dv/v,iter,irl,speed(mm/s)]</span>
utheta = cell(segn,imgsegsz(3));
uvar = cell(segn,imgsegsz(3));
</pre><h2>Iterative Radon transform<a name="4"></a></h2><pre class="codeinput"><span class="keyword">for</span> ii = 1:imgsegsz(3)
    <span class="keyword">for</span> jj = 1:segn
        irl = 1; <span class="comment">% iterative radon level</span>
        curangle = 0; alltheta = []; allvar = []; iter = 0; thetastep = firstthetastep; curvarmax = 0;
        curimgseg = imgseg(segstart(jj):segend(jj),xrange(1):xrange(2),ii);
        <span class="keyword">if</span> ii==1
            curimgseg = curimgseg-mean(curimgseg(:)); <span class="comment">% element-wise demean</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> ii==2
            curimgseg = bsxfun(@minus,curimgseg,mean(curimgseg,1)); <span class="comment">% vertical demean</span>
        <span class="keyword">end</span>
       <span class="keyword">while</span> irl
            iter = iter+1;
            <span class="comment">% smart iterative radon function with graded angle steps</span>
            <span class="keyword">if</span> iter==1
                theta = firstiter;
            <span class="keyword">else</span>
                thetastep = thetastep/2;
                theta = (-3*thetastep+curangle):thetastep*2:(3*thetastep+curangle);
            <span class="keyword">end</span>
            theta = mod(theta+90,180)-90; <span class="comment">% ensures angle range of [-90,+90)</span>
            R = radon(curimgseg,theta); <span class="comment">% Eq. 7</span>
            R(R==0) = nan; <span class="comment">% avoids influence of non-participant pixels</span>
            curvar = nanvar(R);
            alltheta = [alltheta theta];
            allvar = [allvar curvar];
            [Rvarmaxval,Rvarmaxin] = max(curvar);
            <span class="keyword">if</span> Rvarmaxval&gt;curvarmax
                curangle = theta(Rvarmaxin); <span class="comment">% Eq. 8</span>
                curvarmax = Rvarmaxval;
            <span class="keyword">end</span>
            <span class="keyword">if</span> irl==1 &amp;&amp; thetastep&lt;1 <span class="comment">% angle resolution less than 1 deg</span>
                irl=2; <span class="comment">% iterative radon level 2, where step-size is decided for given dv/v</span>
                curmpa = abs(atand((dvov+1)*tand(curangle))-curangle); <span class="comment">% Eq. 17</span>
                ws = min(wi,ceil(hi*abs(tand(curangle)))); <span class="comment">% Eq. 14</span>
                hs = min(hi,ceil(wi*abs(cotd(curangle)))); <span class="comment">% Eq. 14</span>
                ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); <span class="comment">% Eq. 13</span>
                dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws&gt;hs)-atand(ws/(hs-1))*(ws&lt;=hs)); <span class="comment">% Eq. 12</span>
                deln = dels1/ns; <span class="comment">% Eq. 11</span>

            <span class="keyword">end</span>
            <span class="keyword">if</span> irl&gt;1 &amp;&amp; thetastep&lt;deln <span class="comment">% Eq. 11</span>
                ws = min(wi,ceil(hi*abs(tand(curangle)))); <span class="comment">% Eq. 14</span>
                hs = min(hi,ceil(wi*abs(cotd(curangle)))); <span class="comment">% Eq. 14</span>
                ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); <span class="comment">% Eq. 13</span>
                dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws&gt;hs)-atand(ws/(hs-1))*(ws&lt;=hs)); <span class="comment">% Eq. 12</span>
                deln = dels1/ns; <span class="comment">% Eq. 11</span>
                <span class="keyword">if</span> thetastep&lt;deln
                    <span class="keyword">break</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>

            <span class="keyword">if</span> irl&gt;1 &amp;&amp; thetastep&lt;curmpa <span class="comment">% Eq. 17</span>
                <span class="comment">% actual dv/v calculation</span>
                actdvovper = abs(tand(thetastep+curangle)/tand(curangle)-1)*100; <span class="comment">% Eq. 16</span>
                <span class="keyword">if</span> dvov&gt;actdvovper/100
                    <span class="keyword">break</span>
                <span class="keyword">else</span>
                    irl = irl+1;
                    curmpa = atand((dvov+1)*tand(abs(curangle)))-abs(curangle); <span class="comment">% Eq. 17</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        angle(jj,1,ii) = curangle;

        <span class="comment">% actual dv/v</span>
        actdvovper = abs(tand(thetastep+curangle)/tand(curangle)-1)*100; <span class="comment">% Eq. 16</span>
        <span class="comment">% deln</span>
        ws = min(wi,ceil(hi*abs(tand(curangle)))); <span class="comment">% Eq. 14</span>
        hs = min(hi,ceil(wi*abs(cotd(curangle)))); <span class="comment">% Eq. 14</span>
        ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); <span class="comment">% Eq. 13</span>
        dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws&gt;hs)-atand(ws/(hs-1))*(ws&lt;=hs)); <span class="comment">% Eq. 12</span>
        deln = dels1/ns; <span class="comment">% Eq. 11</span>

        angle(jj,2:9,ii) = [thetastep segstart(jj)+hi/2 dels1 deln actdvovper iter irl tand(curangle)*delx/delt];

        <span class="comment">% unique angles used for radon and variance measured</span>
        [utheta{jj,ii},um] = sort(alltheta);
        uvar{jj,ii} = allvar(um);
    <span class="keyword">end</span>
    <span class="keyword">if</span> showimg
        figure(1496);
        <span class="comment">% linescan plot with angle</span>
        subplot(1,imgsegsz(3)*2,ii+imgsegsz(3));
        imagesc(imgseg(:,:,ii)); axis <span class="string">image</span>; title(curimtitle{ii});
        set(gca,<span class="string">'XTickLabel'</span>,[],<span class="string">'YTickLabel'</span>,[]);
        hold <span class="string">on</span>;
        <span class="keyword">for</span> jj=1:segn
        [xp,yp] = pol2cart(mod(angle(jj,1,ii)*pi/180-pi/2,pi),wi/2);
        line(xrange(1)+wi/2+[-xp xp],angle(jj,3,ii)-[-yp yp],<span class="keyword">...</span>
            <span class="string">'Color'</span>,<span class="string">'black'</span>,<span class="string">'LineWidth'</span>,anglineth,<span class="string">'EraseMode'</span>,<span class="string">'xor'</span>);
        <span class="keyword">end</span>
        hold <span class="string">off</span>;
        <span class="keyword">if</span> ii==1
            ylabel({<span class="string">'processed image'</span>;<span class="keyword">...</span>
                [<span class="string">'\Deltax = '</span> num2str(delx) <span class="string">' \mum/pixel, \Deltat = '</span> num2str(delt) <span class="keyword">...</span>
                <span class="string">' ms/line, h = '</span> num2str(imgsegsz(1)) <span class="string">' pixels'</span>]});
            xlabel([<span class="string">'w = '</span> num2str(imgsegsz(2))]);
        <span class="keyword">end</span>

        <span class="comment">% angle plot</span>
        subplot(2,imgsegsz(3)*2,+(1:imgsegsz(3)))
        plot(angle(:,3,ii)*delt,angle(:,1,ii),[<span class="string">'-o'</span> curcolor{ii} ]); hold <span class="string">on</span>;
        <span class="keyword">if</span> ii==imgsegsz(3)
            legend(curimtitle{1:ii},<span class="string">'Location'</span>,<span class="string">'s'</span>);
            xlabel(<span class="string">'time (ms)'</span>); ylabel(<span class="string">'\theta (^o)'</span>); hold <span class="string">off</span>
            title (imgtitle); ylim([min(angle(:,1,ii))-5 max(angle(:,1,ii))+5])
        <span class="keyword">end</span>

        <span class="comment">% velocity plot</span>
        subplot(2,imgsegsz(3)*2,imgsegsz(3)*2+(1:imgsegsz(3)))
        plot(angle(:,3,ii)*delt,angle(:,9,ii),[<span class="string">'-o'</span> curcolor{ii} ]); hold <span class="string">on</span>;
        <span class="keyword">if</span> ii==imgsegsz(3)
            legend(curimtitle{1:ii},<span class="string">'Location'</span>,<span class="string">'s'</span>);
            xlabel(<span class="string">'time (ms)'</span>); ylabel(<span class="string">'v (mm/s)'</span>); hold <span class="string">off</span>
            ylim([min(angle(:,9,ii))-1 max(angle(:,9,ii))+1])
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

warning <span class="string">on</span>
</pre><img vspace="5" hspace="5" src="hybridvelexec_01.png"> <p class="footer"><br>
            Published with MATLAB&reg; 7.5<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
% [angle,utheta,uvar] = hybridvel(imread('fig9im.tif'),1,[],0.47,1,100,25,[1 125]);

%% Initialize

% load the image
imgtitle = 'fig9im.tif';
inputimg = imread(imgtitle);

% set up parameters
imsize = size(inputimg);
inputimg = double(inputimg);
anglineth = 3; 
dvov = 0.1/100; % dv/v to determine minimum step-size
firstthetastep = 45; thetarange = [0 179];
ds = 4; % 4 um streak distance
showimg = 1;
delx = 0.47; % microns/pixel
delt = 1; % ms/line
hi = 100;
lineskip = 25;
xrange = [1 125];

if ~isempty(xrange) && length(xrange)<3
    if length(xrange)==1
        wi = xrange; xrange = [1 wi];
    else
        if xrange(1)>imsize(2)-1
            xrange(1)=1;
        end
        if xrange(2)>imsize(2)-1
            xrange(2)=imsize(2)-2;
        end
        if xrange(2)<xrange(1)
            xrange = [xrange(1) xrange(2)];
        end
        wi = xrange(2)-xrange(1)+1;
    end
else
    wi = imsize(2)-2; xrange = [1 wi];
end

warning off

%% Process the image with different filters

curimtitle = {'edm','vdm','sob'}; curcolor = {'b','g','k','r','c','m'};
imgseg(:,:,1) = inputimg(2:end-1,2:end-1)-mean(mean(inputimg(2:end-1,2:end-1))); % element-wise demean
imgseg(:,:,2) = bsxfun(@minus,inputimg(2:end-1,2:end-1),...
    mean(inputimg(2:end-1,2:end-1),1)); % vertical demean
imgseg(:,:,3) = filter2([1 2 1; 0 0 0; -1 -2 -1],inputimg,'valid');  % 3x3 vertical Sobel filter, Eq. 5,6

imgsegsz = size(imgseg);
firstiter = (thetarange(1):firstthetastep:thetarange(2));
firstiter = firstiter-(firstiter(end)-firstiter(1))/2+1;

segend = hi:lineskip:imgsegsz(1);
segstart = segend-hi+1;
segn = length(segstart);

angle = nan(segn,9,imgsegsz(3)); % angle = [angle,minstep,loc(pix),dels1,deln,%dv/v,iter,irl,speed(mm/s)]
utheta = cell(segn,imgsegsz(3)); 
uvar = cell(segn,imgsegsz(3));

%% Iterative Radon transform

for ii = 1:imgsegsz(3)
    for jj = 1:segn
        irl = 1; % iterative radon level
        curangle = 0; alltheta = []; allvar = []; iter = 0; thetastep = firstthetastep; curvarmax = 0;
        curimgseg = imgseg(segstart(jj):segend(jj),xrange(1):xrange(2),ii);
        if ii==1
            curimgseg = curimgseg-mean(curimgseg(:)); % element-wise demean
        end
        if ii==2
            curimgseg = bsxfun(@minus,curimgseg,mean(curimgseg,1)); % vertical demean
        end
       while irl
            iter = iter+1;
            % smart iterative radon function with graded angle steps
            if iter==1
                theta = firstiter;
            else
                thetastep = thetastep/2;
                theta = (-3*thetastep+curangle):thetastep*2:(3*thetastep+curangle);
            end
            theta = mod(theta+90,180)-90; % ensures angle range of [-90,+90)
            R = radon(curimgseg,theta); % Eq. 7
            R(R==0) = nan; % avoids influence of non-participant pixels
            curvar = nanvar(R);
            alltheta = [alltheta theta];
            allvar = [allvar curvar];
            [Rvarmaxval,Rvarmaxin] = max(curvar);
            if Rvarmaxval>curvarmax
                curangle = theta(Rvarmaxin); % Eq. 8
                curvarmax = Rvarmaxval;
            end
            if irl==1 && thetastep<1 % angle resolution less than 1 deg
                irl=2; % iterative radon level 2, where step-size is decided for given dv/v
                curmpa = abs(atand((dvov+1)*tand(curangle))-curangle); % Eq. 17
                ws = min(wi,ceil(hi*abs(tand(curangle)))); % Eq. 14
                hs = min(hi,ceil(wi*abs(cotd(curangle)))); % Eq. 14
                ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); % Eq. 13
                dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws>hs)-atand(ws/(hs-1))*(ws<=hs)); % Eq. 12
                deln = dels1/ns; % Eq. 11
                
            end
            if irl>1 && thetastep<deln % Eq. 11
                ws = min(wi,ceil(hi*abs(tand(curangle)))); % Eq. 14
                hs = min(hi,ceil(wi*abs(cotd(curangle)))); % Eq. 14
                ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); % Eq. 13
                dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws>hs)-atand(ws/(hs-1))*(ws<=hs)); % Eq. 12
                deln = dels1/ns; % Eq. 11
                if thetastep<deln
                    break
                end
            end
                
            if irl>1 && thetastep<curmpa % Eq. 17
                % actual dv/v calculation
                actdvovper = abs(tand(thetastep+curangle)/tand(curangle)-1)*100; % Eq. 16
                if dvov>actdvovper/100
                    break
                else
                    irl = irl+1;
                    curmpa = atand((dvov+1)*tand(abs(curangle)))-abs(curangle); % Eq. 17
                end
            end
        end
        angle(jj,1,ii) = curangle;

        % actual dv/v 
        actdvovper = abs(tand(thetastep+curangle)/tand(curangle)-1)*100; % Eq. 16
        % deln
        ws = min(wi,ceil(hi*abs(tand(curangle)))); % Eq. 14
        hs = min(hi,ceil(wi*abs(cotd(curangle)))); % Eq. 14
        ns = floor(wi*delx/ds)*(hs==hi)+((hi*delx*ws)/(ds*hs))*(ws==wi); % Eq. 13
        dels1 = abs(atand(ws/hs)-atand((ws-1)/hs)*(ws>hs)-atand(ws/(hs-1))*(ws<=hs)); % Eq. 12
        deln = dels1/ns; % Eq. 11

        angle(jj,2:9,ii) = [thetastep segstart(jj)+hi/2 dels1 deln actdvovper iter irl tand(curangle)*delx/delt];

        % unique angles used for radon and variance measured
        [utheta{jj,ii},um] = sort(alltheta);
        uvar{jj,ii} = allvar(um);
    end
    if showimg
        figure(1496);
        % linescan plot with angle
        subplot(1,imgsegsz(3)*2,ii+imgsegsz(3));
        imagesc(imgseg(:,:,ii)); axis image; title(curimtitle{ii});
        set(gca,'XTickLabel',[],'YTickLabel',[]);
        hold on;
        for jj=1:segn
        [xp,yp] = pol2cart(mod(angle(jj,1,ii)*pi/180-pi/2,pi),wi/2);
        line(xrange(1)+wi/2+[-xp xp],angle(jj,3,ii)-[-yp yp],...
            'Color','black','LineWidth',anglineth,'EraseMode','xor');
        end
        hold off;
        if ii==1
            ylabel({'processed image';...
                ['\Deltax = ' num2str(delx) ' \mum/pixel, \Deltat = ' num2str(delt) ...
                ' ms/line, h = ' num2str(imgsegsz(1)) ' pixels']});
            xlabel(['w = ' num2str(imgsegsz(2))]);
        end
        
        % angle plot
        subplot(2,imgsegsz(3)*2,+(1:imgsegsz(3)))
        plot(angle(:,3,ii)*delt,angle(:,1,ii),['-o' curcolor{ii} ]); hold on;
        if ii==imgsegsz(3)
            legend(curimtitle{1:ii},'Location','s'); 
            xlabel('time (ms)'); ylabel('\theta (^o)'); hold off
            title (imgtitle); ylim([min(angle(:,1,ii))-5 max(angle(:,1,ii))+5])
        end
            
        % velocity plot
        subplot(2,imgsegsz(3)*2,imgsegsz(3)*2+(1:imgsegsz(3)))
        plot(angle(:,3,ii)*delt,angle(:,9,ii),['-o' curcolor{ii} ]); hold on;
        if ii==imgsegsz(3)
            legend(curimtitle{1:ii},'Location','s'); 
            xlabel('time (ms)'); ylabel('v (mm/s)'); hold off
            ylim([min(angle(:,9,ii))-1 max(angle(:,9,ii))+1])
        end
    end
end

warning on
##### SOURCE END #####
-->
   </body>
</html>